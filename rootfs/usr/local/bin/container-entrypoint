#!/bin/sh
# shellcheck shell=dash
set -euo pipefail
# shellcheck disable=SC2154
if [ -n "${DEBUG+x}" ]; then
    set -x
fi

export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
readonly iface="${IFACE:-$(ip -4 route show 0/0 | awk '{ print $5 }')}"

if [ -n "$(ip -4 route list scope link | head -c 1)" ]; then
    if [ -z "$(iptables-save | head -c 1)" ]; then
        iptables-restore '/etc/iptables/default-policy'
        iptables-restore -n '/etc/iptables/ipv4-default'
    fi

    { grep -E '^-(A|I) ' '/etc/iptables/ipv4-custom' || :; } \
    | sed "s/{IFACE}/${iface}/g" \
    | while read -r rule; do
        check=$(printf '%s' "${rule}" | sed -E 's/^-.( \S+)( \d+)?(.+)/-C\1\3/')
        # shellcheck disable=SC2086
        iptables ${check} 2> '/dev/null' || iptables ${rule}
    done
fi

if [ -n "$(ip -6 route list scope link | head -c 1)" ]; then
    if [ -z "$(ip6tables-save | head -c 1)" ]; then
        ip6tables-restore '/etc/iptables/default-policy'
    fi
fi

if [ "$1" = 'container-daemon' ]; then
    subnet="$(ip -4 route show 0/0 | awk '{ sub(/\d+$/, "*", $3); print $3 }')"
    allowed="$(printf '127.0.0.1,%s' "${subnet}")"
    rpc_username="${RPC_USERNAME:-transmission}"
    rpc_password="${RPC_PASSWORD:-$(dd if='/dev/urandom' bs=1 count=64 2> '/dev/null' | base64 | tr -d '\n' | head -c 32)}"
    incomplete='/data/.incomplete'

    mkdir -p "${incomplete}"

    set -- transmission-daemon --foreground \
        --allowed "${allowed}" --port 9091 --peerport 51413 \
        --auth --username "${rpc_username}" --password "${rpc_password}" \
        --no-portmap --config-dir '/app' \
        --incomplete-dir "${incomplete}" \
        --download-dir '/data'
fi

exec "$@"
