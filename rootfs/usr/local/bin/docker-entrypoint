#!/bin/sh
if [ -n "${DEBUG}" ]; then
    set -x
fi

user='transmission'
uid="${HOST_UID:-$(shuf -i 10000-65533 -n 1)}"
gid="${HOST_GID:-$uid}"
home="/run/user/${uid}"

'/bin/mkdir' -p "${home}"

if ! '/usr/bin/getent' group "${gid}" > '/dev/null'; then
    '/usr/sbin/addgroup' -g "${gid}" -S "${user}"
fi

if ! '/usr/bin/getent' passwd "${uid}" > '/dev/null'; then
    '/usr/sbin/adduser' -h "${home}" -s '/sbin/nologin' \
        -g "${user}" -G "${user}" -SD -u "${uid}" "${user}"
else
    '/bin/chown' "${uid}:${gid}" "${home}"
fi

if ! '/bin/chown' -R "${uid}:${gid}" '/app'; then
    exit 1
fi

if '/sbin/ip' -4 route | '/bin/grep' -q $; then
    if ! '/sbin/iptables-save' | '/bin/grep' -qE '^\:ICMP\-'; then
        if ! '/sbin/iptables-restore' '/etc/iptables/default-policy'; then
            exit 1
        fi

        if ! '/sbin/iptables-restore' -n '/etc/iptables/ipv4-default'; then
            exit 1
        fi
    fi

    if ! '/sbin/iptables-restore' -n '/etc/iptables/ipv4-custom'; then
        exit 1
    fi
fi

if '/sbin/ip' -6 route | '/bin/grep' -q $; then
    if ! '/sbin/ip6tables-save' | '/bin/grep' -qE '^\-'; then
        if ! '/sbin/ip6tables-restore' '/etc/iptables/default-policy'; then
            exit 1
        fi
    fi
fi

if [ "$1" == 'container-daemon' ]; then
    rpc_username="${RPC_USERNAME:-$user}"
    rpc_password="${RPC_PASSWORD:-$(cat /dev/urandom | tr -dc A-Za-z0-9 | head -c32)}"
    incomplete='/data/.incomplete'

    '/bin/mkdir' -p "${incomplete}"
    '/bin/chown' -R "${uid}:${gid}" "${incomplete}"

    allowed='127.0.0.1'
    subnet=$(ip route show default 0.0.0.0/0 | awk '{ print $3 }' | cut -d . -f 1-3)
    if [ -n "${subnet:+x}" ]; then
        allowed=$(printf '%s,%s.*' "${allowed}" "${subnet}")
    fi

    set -- '/usr/bin/transmission-daemon' --foreground \
        --allowed "${allowed}" --port 9091 --peerport 51413 \
        --auth --username "${rpc_username}" --password "${rpc_password}" \
        --no-portmap --config-dir '/app' \
        --incomplete-dir "${incomplete}" \
        --download-dir '/data'
fi

exec '/sbin/su-exec' "${uid}:${gid}" "$@"
